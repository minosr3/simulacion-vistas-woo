/**
 * Plugin Name: Woo Fake Activity Notices
 * Description: Muestra personas viendo el producto y ventas recientes con persistencia por producto.
 * Version: 1.1.1
 * Author: Minosr3

/**
 * Shortcode: Personas viendo el producto (con persistencia)
 */
function people_viewing_product_shortcode() {

    if ( ! is_product() ) {
        return '';
    }

    global $product;
    if ( ! $product ) {
        return '';
    }

    $product_id = $product->get_id();
    $transient_key = 'people_viewing_product_' . $product_id;

    // Obtener valor persistente
    $views = get_transient( $transient_key );

    // Si no existe, generar uno nuevo
    if ( $views === false ) {
        $views = mt_rand(3, 18); // rango realista
        set_transient( $transient_key, $views, 10 * MINUTE_IN_SECONDS );
    }

    // Texto singular / plural
    if ( $views === 1 ) {
        $text = sprintf(
            _x( 'Â¡%d persona estÃ¡ viendo este producto ahora mismo!', 'viewing singular', 'your-text-domain' ),
            $views
        );
    } else {
        $text = sprintf(
            _x( 'Â¡%d personas estÃ¡n viendo este producto ahora mismo!', 'viewing plural', 'your-text-domain' ),
            $views
        );
    }

    return '<div class="people-viewing-notice">
                <span class="viewing-icon">ðŸ”Ž</span> ' . esc_html( $text ) . '
            </div>';
}
add_shortcode( 'people_viewing_product', 'people_viewing_product_shortcode' );


/**
 * Shortcode: Ventas recientes (con persistencia)
 */
function fake_sales_product_shortcode() {

    if ( ! is_product() ) {
        return '';
    }

    global $product;
    if ( ! $product ) {
        return '';
    }

    $product_id = $product->get_id();
    $transient_key = 'fake_sales_product_' . $product_id;

    // Obtener valor persistente
    $sales = get_transient( $transient_key );

    // Si no existe, generar uno nuevo
    if ( $sales === false ) {
        $sales = mt_rand(2, 25); // rango realista
        set_transient( $transient_key, $sales, 30 * MINUTE_IN_SECONDS );
    }

    // Texto singular / plural
    if ( $sales === 1 ) {
        $text = sprintf(
            _x( 'Â¡%d artÃ­culo vendido en las Ãºltimas 5 horas!', 'sales singular', 'your-text-domain' ),
            $sales
        );
    } else {
        $text = sprintf(
            _x( 'Â¡%d artÃ­culos vendidos en las Ãºltimas 5 horas!', 'sales plural', 'your-text-domain' ),
            $sales
        );
    }

    return '<div class="sales-notice">
                <span class="sales-icon">ðŸ”¥</span> ' . esc_html( $text ) . '
            </div>';
}
add_shortcode( 'fake_sales_product', 'fake_sales_product_shortcode' );


/**
 * Insertar notificaciones debajo del botÃ³n "AÃ±adir al carrito"
 */
function insert_product_notices_after_cart() {

    if ( ! is_product() ) {
        return;
    }

    echo do_shortcode( '[fake_sales_product]' );
    echo do_shortcode( '[people_viewing_product]' );
}
add_action( 'woocommerce_after_add_to_cart_form', 'insert_product_notices_after_cart', 10 );
